{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-graph-up-arrow me-2"></i>PERFORMANCE METRICS</h2>
    <a href="{{ url_for('export_data') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-download"></i> Export Data
    </a>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-8">
        <div class="card shadow-sm h-100 bg-dark border-secondary">
            <div class="card-body">
                <h5 class="text-muted text-uppercase small">Habit Resonance (Health Score)</h5>
                <div class="d-flex align-items-center mt-2">
                    <h2 class="display-4 fw-bold text-white me-4 mb-0">{{ health_score }}%</h2>
                    <div class="progress flex-grow-1" style="height: 10px; background-color: rgba(255,255,255,0.1);">
                        <div class="progress-bar {% if health_score > 70 %}bg-success{% elif health_score > 40 %}bg-warning{% else %}bg-danger{% endif %}"
                             role="progressbar" style="width: {{ health_score }}%"></div>
                    </div>
                </div>
                <p class="small text-muted mt-2 mb-0">Based on recent activity consistency.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm h-100 bg-dark border-secondary position-relative overflow-hidden">
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h6 class="text-info text-uppercase small letter-spacing">Total Experience</h6>
                <h1 class="display-3 fw-bold text-white mb-0">{{ user.total_xp }}</h1>
                <span class="text-muted small">XP Earned</span>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-5">
        <div class="card shadow-sm h-100 bg-dark border-secondary">
            <div class="card-header border-0 bg-transparent text-center">
                <span class="text-white small text-uppercase">Class Build (Attributes)</span>
            </div>
            <div class="card-body">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card shadow-sm h-100 bg-dark border-secondary">
            <div class="card-header border-0 bg-transparent">
                <span class="text-white small text-uppercase">Progression Velocity (30 Days)</span>
            </div>
            <div class="card-body">
                <canvas id="lineChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm bg-dark border-secondary">
    <div class="card-body">
        <h5 class="card-title text-muted text-uppercase small mb-3">Temporal Activity Log</h5>
        <div id="cal-heatmap" class="d-flex flex-wrap justify-content-center" style="gap: 3px;"></div>
    </div>
</div>

<script>
    // --- RESPONSIVE CONFIG ---
    // Check if we are on mobile (screen width less than 768px)
    const isMobile = window.innerWidth < 768;

    // Set font sizes based on device
    Chart.defaults.font.size = isMobile ? 14 : 12;
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';

    // --- 1. RADAR CHART ---
    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: {{ radar_labels | tojson }},
            datasets: [{
                label: 'Stats',
                data: {{ radar_data | tojson }},
                backgroundColor: 'rgba(188, 19, 254, 0.2)',
                borderColor: '#bc13fe',
                pointBackgroundColor: '#bc13fe',
                pointBorderColor: '#fff',
                pointRadius: isMobile ? 3 : 4 // Smaller points on mobile
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // CRITICAL: Allows chart to fill height
            scales: {
                r: {
                    angleLines: { color: 'rgba(255,255,255,0.1)' },
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    pointLabels: {
                        color: '#fff',
                        font: { size: isMobile ? 10 : 12 } // Adjust label size
                    },
                    ticks: { display: false, backdropColor: 'transparent' }
                }
            },
            plugins: {
                legend: { display: false } // Hide legend to save space
            }
        }
    });

    // --- 2. LINE CHART ---
    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: {{ line_labels | tojson }},
            datasets: [{
                label: 'Total XP',
                data: {{ line_data | tojson }},
                borderColor: '#00f2ff',
                backgroundColor: 'rgba(0, 242, 255, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: 0, // Remove dots for cleaner look on mobile
                pointHitRadius: 20 // Make it easier to tap
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // CRITICAL
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { display: !isMobile } // Hide grid lines on mobile for cleaner look
                },
                x: {
                    ticks: {
                        maxTicksLimit: isMobile ? 5 : 10 // Show fewer dates on mobile
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });

    // --- 3. HEATMAP GENERATOR ---
    const heatmapContainer = document.getElementById('cal-heatmap');
    const heatmapData = {{ heatmap_data | tojson }};
    const today = new Date();

    // Show fewer days on mobile (e.g., 90 days instead of 180)
    const daysToShow = isMobile ? 80 : 180;

    for (let i = daysToShow; i >= 0; i--) {
        const d = new Date();
        d.setDate(today.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const count = heatmapData[dateStr] || 0;

        const box = document.createElement('div');
        // Make boxes slightly bigger on mobile for touch
        const boxSize = isMobile ? '10px' : '12px';
        box.style.width = boxSize;
        box.style.height = boxSize;
        box.style.borderRadius = '2px';
        box.title = `${dateStr}: ${count} XP`;

        if (count === 0) box.style.backgroundColor = '#212529';
        else if (count < 20) box.style.backgroundColor = 'rgba(13, 202, 240, 0.3)';
        else if (count < 50) box.style.backgroundColor = 'rgba(13, 202, 240, 0.6)';
        else box.style.backgroundColor = '#0dcaf0';

        heatmapContainer.appendChild(box);
    }
</script>
{% endblock %}