{% extends "base.html" %}

{% block content %}
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card bg-dark border-secondary h-100 p-4 text-center position-relative overflow-hidden d-flex flex-column justify-content-center">
            <h5 class="text-muted text-uppercase small mb-3">System Consistency</h5>
            <h1 class="display-1 fw-bold text-white mb-0" style="font-family: 'Orbitron', sans-serif;">{{ health_score }}%</h1>
            <div class="progress bg-secondary bg-opacity-10 mt-3" style="height: 6px;">
                <div class="progress-bar bg-{{ 'success' if health_score > 70 else 'warning' if health_score > 30 else 'danger' }}"
                     style="width: {{ health_score }}%"></div>
            </div>
            <p class="small text-muted mt-2">7-Day Activity Rate</p>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-dark border-secondary h-100 p-3">
            <h6 class="text-uppercase text-muted small mb-3 text-center">Attribute Balance</h6>
            <div style="height: 300px; width: 100%; position: relative;">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-dark border-secondary h-100 p-3">
            <h6 class="text-uppercase text-muted small mb-3 text-center">Mission Complexity</h6>
            <div style="height: 300px; width: 100%; position: relative;">
                <canvas id="donutChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card bg-dark border-secondary h-100 p-4">
            <h5 class="text-uppercase text-white mb-3">Daily Output (7 Days)</h5>
            <div style="height: 250px; width: 100%; position: relative;">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card bg-dark border-secondary h-100 p-4">
            <div class="d-flex justify-content-between align-items-end mb-3">
                <h5 class="text-uppercase text-white mb-0">Total XP Velocity</h5>
                <span class="badge bg-secondary border border-secondary text-light">Lifetime Growth</span>
            </div>
            <div style="height: 250px; width: 100%; position: relative;">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="glass-panel" style="margin-top: 30px;">
    <h3>// RECENT NEGLECT MATRIX (7 DAYS)</h3>
    <div style="height: 300px;">
        <canvas id="missedChart"></canvas>
    </div>
</div>

<div class="card bg-dark border-secondary p-4 mb-5">
    <h5 class="text-uppercase text-white mb-4">Activity Heatmap</h5>
    <div class="d-flex flex-wrap gap-1 justify-content-center" id="heatmapContainer"></div>
</div>

<script>
    // --- 1. CONFIG ---
    const isLight = document.body.classList.contains('light-mode');
    const textColor = isLight ? '#212529' : '#94a3b8';
    const gridColor = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.05)';

    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = gridColor;
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;

    // --- 2. RADAR CHART (Fixed Scale) ---
    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: {{ radar_labels | tojson }},
            datasets: [{
                label: 'Stats',
                data: {{ radar_data | tojson }},
                backgroundColor: 'rgba(13, 202, 240, 0.2)',
                borderColor: '#0dcaf0',
                borderWidth: 2,
                pointBackgroundColor: '#0dcaf0',
                pointRadius: 4
            }]
        },
        options: {
            layout: { padding: 10 }, // Give labels room to breathe
            scales: {
                r: {
                    angleLines: { color: gridColor },
                    grid: { color: gridColor },
                    pointLabels: {
                        color: textColor,
                        font: { size: 12, weight: 'bold' } // Make labels bigger
                    },
                    ticks: {
                        display: false, // Hide the messy numbers inside
                        backdropColor: 'transparent'
                    },
                    suggestedMin: 0, // Ensure it starts from center
                }
            },
            plugins: { legend: { display: false } }
        }
    });

    // --- 3. DONUT CHART ---
    new Chart(document.getElementById('donutChart'), {
        type: 'doughnut',
        data: {
            labels: ['Easy', 'Medium', 'Hard', 'Epic'],
            datasets: [{
                data: {{ diff_data | tojson }},
                backgroundColor: ['#20c997', '#0dcaf0', '#fd7e14', '#dc3545'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '70%', // Thinner ring looks more modern
            plugins: { legend: { position: 'bottom', labels: { padding: 20, boxWidth: 10 } } }
        }
    });

    // --- 4. BAR CHART ---
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: {{ bar_labels | tojson }},
            datasets: [{
                label: 'XP Gained',
                data: {{ bar_data | tojson }},
                backgroundColor: '#0dcaf0',
                borderRadius: 4,
                barPercentage: 0.6
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, grid: { color: gridColor } },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });

    // --- 5. LINE CHART ---
    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: {{ line_labels | tojson }},
            datasets: [{
                label: 'Total XP',
                data: {{ line_data | tojson }},
                borderColor: '#0dcaf0',
                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            interaction: { intersect: false, mode: 'index' },
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false } },
                y: { grid: { color: gridColor } }
            }
        }
    });

    // --- 6. HEATMAP ---
    const heatmapData = {{ heatmap_data | tojson }};
    const container = document.getElementById('heatmapContainer');
    const today = new Date();

    for (let i = 59; i >= 0; i--) {
        const d = new Date();
        d.setDate(today.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const xp = heatmapData[dateStr] || 0;

        let colorClass = 'bg-secondary bg-opacity-10';
        if (xp > 0) colorClass = 'bg-info bg-opacity-25';
        if (xp > 50) colorClass = 'bg-info bg-opacity-50';
        if (xp > 100) colorClass = 'bg-info';

        const box = document.createElement('div');
        box.className = `rounded-1 ${colorClass}`;
        box.style.width = '12px';
        box.style.height = '12px';
        box.title = `${dateStr}: ${xp} XP`;
        box.setAttribute('data-bs-toggle', 'tooltip');
        container.appendChild(box);
    }

// --- LOAD MISSED TASK GRAPH ---
async function loadMissedGraph() {
    const response = await fetch('/api/missed_data');
    const missedData = await response.json();

    const ctx = document.getElementById('missedChart').getContext('2d');

    new Chart(ctx, {
        type: 'bubble', // Bubble allows us to store custom data like 'task name'
        data: {
            datasets: [{
                label: 'Missed Objectives',
                data: missedData,
                backgroundColor: 'rgba(255, 99, 132, 0.7)', // Red for danger/missed
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'category', // Shows Dates
                    grid: { color: '#333' },
                    ticks: { color: '#fff' }
                },
                y: {
                    min: -0.5,
                    max: 4.5,
                    grid: { color: '#333' },
                    ticks: {
                        color: '#aaa',
                        callback: function(value) {
                            // Convert numbers back to Category Names
                            const labels = ["General", "Creativity", "Charisma", "Intelligence", "Strength"];
                            return labels[value] || "";
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            // SHOW THE EXACT TASK NAME ON HOVER
                            return ' MISSED: ' + context.raw.task;
                        }
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    titleColor: '#ff4444',
                    bodyFont: { family: 'Courier New', size: 14 }
                },
                legend: { display: false }
            }
        }
    });
}

// Call it on page load
loadMissedGraph();
</script>
{% endblock %}