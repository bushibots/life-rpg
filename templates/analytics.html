{% extends "base.html" %}

{% block content %}

<div class="card bg-dark border-secondary mb-4 shadow-lg">
    <div class="card-body py-3 d-flex justify-content-between align-items-center control-bar">
        
        <div class="mb-2 mb-md-0">
            <h4 class="text-white mb-0" style="font-family: 'Orbitron', sans-serif; letter-spacing: 1px;">
                <i class="bi bi-activity me-2 text-info"></i>
                {% if show_all %}
                    LIFETIME
                {% else %}
                    SECTOR: <span class="text-info">{{ selected_year }}-{{ '%02d'|format(selected_month) }}</span>
                {% endif %}
            </h4>
        </div>
        
        <form action="{{ url_for('analytics') }}" method="GET" class="d-flex gap-2 align-items-center control-bar" style="flex-wrap: wrap;">
            
            <div class="input-group input-group-sm">
                <select name="year" class="form-select bg-dark text-white border-secondary font-monospace">
                    {% for y in range(2025, 2031) %}
                    <option value="{{ y }}" {{ 'selected' if selected_year == y }}>{{ y }}</option>
                    {% endfor %}
                </select>
                <select name="month" class="form-select bg-dark text-white border-secondary font-monospace">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {{ 'selected' if selected_month == m }}>
                        {{ ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'][m-1] }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-info fw-bold text-dark">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            
            <div class="d-flex gap-2 control-actions">
                <a href="{{ url_for('analytics', all='true') }}" class="btn btn-sm w-100 {{ 'btn-light fw-bold' if show_all else 'btn-outline-secondary text-muted' }}">
                    ALL TIME
                </a>
                <a href="{{ url_for('analytics') }}" class="btn btn-sm w-100 {{ 'btn-light fw-bold' if not show_all else 'btn-outline-secondary text-muted' }}">
                    CURRENT
                </a>
            </div>
        </form>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12 col-md-4">
        <div class="card bg-dark border-secondary h-100 p-4 position-relative overflow-hidden stat-card">
            <div class="position-absolute top-0 end-0 p-3 opacity-25">
                <i class="bi bi-cpu fs-1 text-light"></i>
            </div>
            <h6 class="text-secondary text-uppercase small mb-3">System Consistency</h6>
            <div class="d-flex align-items-end gap-2 mb-2">
                <h1 class="display-3 fw-bold text-white mb-0" style="font-family: 'Orbitron', sans-serif;">{{ health_score }}%</h1>
                <span class="mb-2 badge {{ 'bg-success' if health_score >= 80 else 'bg-warning' if health_score >= 50 else 'bg-danger' }}">
                    {{ 'OPTIMAL' if health_score >= 80 else 'UNSTABLE' if health_score >= 50 else 'CRITICAL' }}
                </span>
            </div>
            <div class="progress bg-black mt-2" style="height: 6px;">
                <div class="progress-bar bg-{{ 'success' if health_score > 70 else 'info' if health_score > 30 else 'danger' }}"
                     style="width: {{ health_score }}%; box-shadow: 0 0 10px currentColor;"></div>
            </div>
            <p class="small text-muted mt-2 mb-0">Based on activity in selected period</p>
        </div>
    </div>

    <div class="col-12 col-md-4">
        <div class="card bg-dark border-secondary h-100 p-3 stat-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-uppercase text-muted small mb-0">Attribute Balance</h6>
                <i class="bi bi-person-bounding-box text-secondary"></i>
            </div>
            <div class="chart-container" style="height: 250px; width: 100%;">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-4">
        <div class="card bg-dark border-secondary h-100 p-3 stat-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="text-uppercase text-muted small mb-0">Mission Complexity</h6>
                <i class="bi bi-pie-chart text-secondary"></i>
            </div>
            <div class="chart-container" style="height: 250px; width: 100%;">
                <canvas id="donutChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12 col-lg-8">
        <div class="card bg-dark border-secondary h-100 p-4 stat-card">
            <div class="d-flex justify-content-between align-items-end mb-4">
                <div>
                    <h5 class="text-uppercase text-white mb-0" style="font-family: 'Orbitron', sans-serif;">XP Velocity</h5>
                    <p class="text-muted small mb-0">Cumulative Growth Over Time</p>
                </div>
                <span class="badge bg-dark border border-info text-info">
                    <i class="bi bi-arrow-up-right me-1"></i> TRENDING
                </span>
            </div>
            <div class="chart-container" style="height: 300px; width: 100%;">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="card bg-dark border-secondary h-100 p-4 stat-card">
            <h5 class="text-uppercase text-white mb-3" style="font-family: 'Orbitron', sans-serif;">Daily Output</h5>
            <p class="text-muted small mb-3">Last 7 Active Days</p>
            <div class="chart-container" style="height: 300px; width: 100%;">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card bg-dark border-secondary p-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="text-uppercase text-white mb-0" style="font-family: 'Orbitron', sans-serif;">
            <i class="bi bi-grid-3x3 me-2 text-secondary"></i>Activity Heatmap
        </h5>
        <div class="d-flex gap-2 small">
            <span class="text-muted">Less</span>
            <div style="width: 12px; height: 12px;" class="bg-secondary bg-opacity-10 rounded-1"></div>
            <div style="width: 12px; height: 12px;" class="bg-info bg-opacity-25 rounded-1"></div>
            <div style="width: 12px; height: 12px;" class="bg-info bg-opacity-75 rounded-1"></div>
            <div style="width: 12px; height: 12px;" class="bg-info rounded-1"></div>
            <span class="text-muted">More</span>
        </div>
    </div>
    <div class="d-flex flex-wrap gap-1 justify-content-center" id="heatmapContainer"></div>
</div>

<script>
    // --- 1. GLOBAL STYLE CONFIG ---
    const gridColor = 'rgba(255, 255, 255, 0.05)';
    const textColor = '#94a3b8';
    const accentColor = '#0dcaf0'; // Cyan/Info
    
    // Ensure charts scale properly
    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = gridColor;
    Chart.defaults.font.family = "'Inter', 'Segoe UI', sans-serif";
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false; // CRITICAL FOR MOBILE

    // --- 2. RADAR CHART ---
    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: {{ radar_labels | tojson }},
            datasets: [{
                label: 'Attribute Level',
                data: {{ radar_data | tojson }},
                backgroundColor: 'rgba(13, 202, 240, 0.2)',
                borderColor: accentColor,
                borderWidth: 2,
                pointBackgroundColor: accentColor,
                pointBorderColor: '#fff',
                pointRadius: 3
            }]
        },
        options: {
            scales: {
                r: {
                    angleLines: { color: gridColor },
                    grid: { color: gridColor },
                    pointLabels: { color: '#fff', font: { size: 11, weight: '600' } },
                    ticks: { display: false, backdropColor: 'transparent' }
                }
            },
            plugins: { legend: { display: false } }
        }
    });

    // --- 3. DONUT CHART ---
    new Chart(document.getElementById('donutChart'), {
        type: 'doughnut',
        data: {
            labels: ['Easy', 'Medium', 'Hard', 'Epic'],
            datasets: [{
                data: {{ diff_data | tojson }},
                backgroundColor: ['#20c997', '#0dcaf0', '#fd7e14', '#dc3545'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            cutout: '75%',
            plugins: { 
                legend: { 
                    position: 'right', 
                    labels: { boxWidth: 10, padding: 15, color: '#adb5bd', font: { size: 11 } } 
                } 
            }
        }
    });

    // --- 4. BAR CHART ---
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: {{ bar_labels | tojson }},
            datasets: [{
                label: 'XP Gained',
                data: {{ bar_data | tojson }},
                backgroundColor: accentColor,
                borderRadius: 2,
                barPercentage: 0.5
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, grid: { color: gridColor, borderDash: [2, 2] } },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });

    // --- 5. LINE CHART ---
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    const gradient = lineCtx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(13, 202, 240, 0.3)');
    gradient.addColorStop(1, 'rgba(13, 202, 240, 0.0)');

    new Chart(lineCtx, {
        type: 'line',
        data: {
            labels: {{ line_labels | tojson }},
            datasets: [{
                label: 'Total XP',
                data: {{ line_data | tojson }},
                borderColor: accentColor,
                backgroundColor: gradient,
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 6
            }]
        },
        options: {
            interaction: { intersect: false, mode: 'index' },
            scales: {
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } },
                y: { grid: { color: gridColor } }
            },
            plugins: { legend: { display: false } }
        }
    });

    // --- 6. HEATMAP GENERATOR ---
    const heatmapData = {{ heatmap_data | tojson }};
    const container = document.getElementById('heatmapContainer');
    // Generate last 60 days
    for (let i = 59; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const xp = heatmapData[dateStr] || 0;

        let colorClass = 'bg-secondary bg-opacity-10'; // Default Empty
        if (xp > 0) colorClass = 'bg-info bg-opacity-25';
        if (xp > 50) colorClass = 'bg-info bg-opacity-50';
        if (xp > 100) colorClass = 'bg-info';

        const box = document.createElement('div');
        box.className = `rounded-1 ${colorClass}`;
        box.style.width = '14px';
        box.style.height = '14px';
        box.style.cursor = 'pointer';
        box.title = `${dateStr}: ${xp} XP`;
        box.setAttribute('data-bs-toggle', 'tooltip');
        container.appendChild(box);
    }
</script>

{% endblock %}