{% extends "base.html" %}

{% block content %}
<style>
    /* =========================================
       FLAGSHIP CALCULATOR STYLES
       ========================================= */
    .premium-card {
        background: var(--glass-bg) !important;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }

    /* iOS-Style Segmented Control for Tabs */
    .segment-control {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 4px;
        display: flex;
        gap: 4px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .segment-control .nav-link {
        border-radius: 8px;
        color: var(--text-muted);
        font-weight: 500;
        font-size: 0.9rem;
        padding: 8px 16px;
        transition: all 0.3s ease;
        border: none;
        flex: 1;
        text-align: center;
    }
    .segment-control .nav-link.active {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    /* Modern Inputs */
    .modern-input {
        background: rgba(0,0,0,0.2) !important;
        border: 1px solid rgba(255,255,255,0.1) !important;
        color: #fff !important;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    .modern-input:focus {
        border-color: #0dcaf0 !important;
        box-shadow: 0 0 0 2px rgba(13, 202, 240, 0.2) !important;
    }

    /* Custom Range Slider */
    .custom-range {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        outline: none;
    }
    .custom-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #0dcaf0;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(13, 202, 240, 0.5);
        transition: transform 0.1s;
    }
    .custom-range::-webkit-slider-thumb:hover { transform: scale(1.2); }

    /* Strategy Terminal */
    .strategy-terminal {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 16px;
        min-height: 100px;
        text-align: left;
        box-shadow: inset 0 4px 15px rgba(0,0,0,0.5);
    }

    /* Quick Action Pills */
    .quick-pill {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-muted);
        border-radius: 20px;
        padding: 4px 12px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .quick-pill:hover { background: rgba(13, 202, 240, 0.15); color: #0dcaf0; border-color: rgba(13, 202, 240, 0.3); }

    /* Debt Number Glow */
    .debt-number {
        font-family: 'Inter', sans-serif;
        font-size: 4rem;
        font-weight: 800;
        letter-spacing: -2px;
        transition: color 0.5s ease, text-shadow 0.5s ease;
    }
</style>

<div class="row justify-content-center">
    <div class="col-lg-10">

        <div class="text-center mb-5">
            <h2 class="fw-bold text-white mb-2" style="font-family: 'Inter', sans-serif; letter-spacing: -1px;">
                Backlog Recovery Planner
            </h2>
            <p class="text-white-50" style="max-width: 600px; margin: 0 auto;">Quantify your accumulated content and generate a strategic, AI-driven timeline for completion.</p>
        </div>

        <div class="row g-4 align-items-stretch">

            <div class="col-md-6">
                <div class="card premium-card h-100">
                    <div class="card-body p-4 p-md-5">
                        
                        <ul class="nav nav-pills segment-control mb-4" id="calcTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="online-tab" data-bs-toggle="tab" data-bs-target="#online" type="button">
                                    <i class="bi bi-play-circle me-1"></i> Video Content
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="offline-tab" data-bs-toggle="tab" data-bs-target="#offline" type="button">
                                    <i class="bi bi-book me-1"></i> Reading Material
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="calcTabContent">

                            <div class="tab-pane fade show active" id="online" role="tabpanel">
                                <div class="mb-4">
                                    <label class="text-white-50 small fw-semibold mb-2">Total Duration</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="position-relative flex-grow-1">
                                            <input type="number" id="vidHours" class="form-control modern-input ps-3" placeholder="0">
                                            <span class="position-absolute top-50 end-0 translate-middle-y text-white-50 pe-3 small">Hours</span>
                                        </div>
                                        <span class="text-white-50 fw-bold">:</span>
                                        <div class="position-relative flex-grow-1">
                                            <input type="number" id="vidMins" class="form-control modern-input ps-3" placeholder="0">
                                            <span class="position-absolute top-50 end-0 translate-middle-y text-white-50 pe-3 small">Mins</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4 bg-dark bg-opacity-25 p-3 rounded" style="border: 1px solid rgba(255,255,255,0.05);">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="text-white-50 small fw-semibold mb-0">Playback Speed</label>
                                        <span id="speedDisplay" class="badge bg-info text-dark fw-bold">1.5x</span>
                                    </div>
                                    <input type="range" class="custom-range" min="1" max="3" step="0.25" id="speedRange" value="1.5" oninput="updateSpeedLabel(this.value)">
                                </div>

                                <div class="d-flex align-items-center justify-content-between p-3 rounded mb-4" style="background-color: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);">
                                    <div>
                                        <label class="fw-semibold text-white mb-0" style="font-size: 0.9rem;">Aggressive Skipping</label>
                                        <div class="small text-white-50">Auto-deduct 10% for intros & fluff</div>
                                    </div>
                                    <div class="form-check form-switch m-0">
                                        <input class="form-check-input" type="checkbox" id="skipIntro" style="width: 2.5em; height: 1.2em; cursor: pointer;">
                                    </div>
                                </div>

                                <button class="btn btn-info w-100 fw-semibold text-dark py-2" style="border-radius: 8px;" onclick="calculateOnline()">
                                    Calculate Processing Time
                                </button>
                            </div>

                            <div class="tab-pane fade" id="offline" role="tabpanel">
                                <div class="mb-4">
                                    <label class="text-white-50 small fw-semibold mb-2">Document Volume</label>
                                    <div class="position-relative mb-2">
                                        <input type="number" id="chapters" class="form-control modern-input ps-3" placeholder="e.g. 5">
                                        <span class="position-absolute top-50 end-0 translate-middle-y text-white-50 pe-3 small">Chapters / Modules</span>
                                    </div>
                                    <div class="position-relative">
                                        <input type="number" id="pagesPerChap" class="form-control modern-input ps-3" placeholder="e.g. 15">
                                        <span class="position-absolute top-50 end-0 translate-middle-y text-white-50 pe-3 small">Avg Pages per Chapter</span>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="text-white-50 small fw-semibold mb-2">Comprehension Depth</label>
                                    <select id="readingSpeed" class="form-select modern-input py-2">
                                        <option value="2">Surface Level Skim (~2 min/page)</option>
                                        <option value="5" selected>Standard Study (~5 min/page)</option>
                                        <option value="10">Deep Understanding (~10 min/page)</option>
                                        <option value="15">Heavy Note-Taking (~15 min/page)</option>
                                    </select>
                                </div>

                                <button class="btn btn-info w-100 fw-semibold text-dark py-2" style="border-radius: 8px;" onclick="calculateOffline()">
                                    Calculate Processing Time
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card premium-card h-100">
                    <div class="card-header bg-transparent border-bottom-0 pt-4 pb-0 px-4 px-md-5">
                        <h6 class="text-white fw-bold mb-0 text-uppercase" style="letter-spacing: 1px;"><i class="bi bi-clock-history me-2 text-info"></i>Analysis & Strategy</h6>
                    </div>
                    
                    <div class="card-body p-4 p-md-5 d-flex flex-column justify-content-between">

                        <div class="text-center mb-4 pb-4 border-bottom" style="border-color: rgba(255,255,255,0.05) !important;">
                            <h1 class="debt-number text-white mb-0" id="totalHoursDisplay">0.0<span style="font-size: 1.5rem; font-weight: 500; opacity: 0.5;">h</span></h1>
                            <span class="badge bg-secondary bg-opacity-25 text-white-50 border border-secondary rounded-pill mt-2 px-3 py-2 fw-normal">Total Time Debt</span>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="text-white-50 small fw-semibold mb-0">Daily Capacity Allocation</label>
                                <div class="d-flex gap-1">
                                    <button class="quick-pill" onclick="setDailyEffort(1)">1h</button>
                                    <button class="quick-pill" onclick="setDailyEffort(2)">2h</button>
                                    <button class="quick-pill" onclick="setDailyEffort(4)">4h</button>
                                </div>
                            </div>
                            <div class="position-relative">
                                <input type="number" id="dailyEffort" class="form-control modern-input ps-3 py-2 text-info fw-bold" placeholder="Hours per day" oninput="updateDate()">
                                <i class="bi bi-lightning-charge position-absolute top-50 end-0 translate-middle-y pe-3 text-info opacity-50"></i>
                            </div>
                        </div>

                        <div class="d-grid mb-4">
                            <div class="p-3 text-center rounded" id="dateOutputBox" style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);">
                                <span class="text-white-50 small fw-semibold" id="dateOutput">AWAITING CAPACITY INPUT</span>
                            </div>
                        </div>

                        <div class="strategy-terminal position-relative">
                            <div class="position-absolute top-0 start-0 w-100 px-3 py-1 bg-dark bg-opacity-50 border-bottom" style="border-color: rgba(255,255,255,0.05) !important; border-radius: 12px 12px 0 0;">
                                <small class="text-white-50" style="font-size: 0.65rem; letter-spacing: 1px;">SYSTEM_ADVISORY_TERMINAL</small>
                            </div>
                            <p class="small text-muted mt-4 mb-0 font-monospace lh-lg" id="motivationText">
                                Data required to formulate recovery timeline. Awaiting input...
                            </p>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    let currentDebtHours = 0;

    // --- UI UPDATES ---
    function updateSpeedLabel(val) {
        document.getElementById('speedDisplay').innerText = val + 'x';
        // Auto-recalculate if hours are already entered
        if (document.getElementById('vidHours').value || document.getElementById('vidMins').value) {
            calculateOnline();
        }
    }

    function setDailyEffort(hours) {
        document.getElementById('dailyEffort').value = hours;
        updateDate();
    }

    // --- MATH ---
    function calculateOnline() {
        let h = parseFloat(document.getElementById('vidHours').value) || 0;
        let m = parseFloat(document.getElementById('vidMins').value) || 0;
        let speed = parseFloat(document.getElementById('speedRange').value);
        let skip = document.getElementById('skipIntro').checked;

        if (h === 0 && m === 0) return;

        let totalRawMinutes = (h * 60) + m;
        if (skip) totalRawMinutes = totalRawMinutes * 0.9; // 10% reduction

        currentDebtHours = (totalRawMinutes / speed) / 60;
        updateDebtDisplay();
    }

    function calculateOffline() {
        let chapters = parseFloat(document.getElementById('chapters').value) || 0;
        let pages = parseFloat(document.getElementById('pagesPerChap').value) || 0;
        let minsPerPage = parseFloat(document.getElementById('readingSpeed').value) || 0;

        if (chapters === 0 || pages === 0) return;

        let totalMinutes = (chapters * pages) * minsPerPage;
        currentDebtHours = totalMinutes / 60;
        updateDebtDisplay();
    }

    // --- DISPLAY & COLOR LOGIC ---
    function updateDebtDisplay() {
        const displayElem = document.getElementById('totalHoursDisplay');
        displayElem.innerHTML = currentDebtHours.toFixed(1) + '<span style="font-size: 1.5rem; font-weight: 500; opacity: 0.5;">h</span>';
        
        // Flagship feature: Color shifting based on debt severity
        if (currentDebtHours < 5) {
            displayElem.style.color = '#0aff68'; // Green
            displayElem.style.textShadow = '0 0 20px rgba(10, 255, 104, 0.4)';
        } else if (currentDebtHours < 15) {
            displayElem.style.color = '#ffd700'; // Yellow
            displayElem.style.textShadow = '0 0 20px rgba(255, 215, 0, 0.4)';
        } else {
            displayElem.style.color = '#ff4444'; // Red
            displayElem.style.textShadow = '0 0 20px rgba(255, 68, 68, 0.4)';
        }

        if(document.getElementById('dailyEffort').value) {
            updateDate();
        }
    }

    // --- TERMINAL TYPEWRITER EFFECT ---
    function typeWriter(text, elementId) {
        let i = 0;
        let elem = document.getElementById(elementId);

        elem.classList.remove('text-muted');
        elem.classList.add('text-info');
        elem.innerHTML = '<span class="text-white opacity-50">> STRATEGY: </span>';

        function type() {
            if (i < text.length) {
                elem.innerHTML += text.charAt(i);
                i++;
                setTimeout(type, 20); // Faster, more mechanical typing speed
            }
        }
        type();
    }

    // --- UPLINK API & DATE LOGIC ---
    async function updateDate() {
        let daily = parseFloat(document.getElementById('dailyEffort').value) || 0;
        let out = document.getElementById('dateOutput');
        let outBox = document.getElementById('dateOutputBox');
        let terminal = document.getElementById('motivationText');

        if (daily <= 0 || currentDebtHours <= 0) {
            out.innerText = "AWAITING CAPACITY INPUT";
            outBox.style.borderColor = "rgba(255,255,255,0.05)";
            return;
        }

        let daysNeeded = Math.ceil(currentDebtHours / daily);
        let targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + daysNeeded);
        let options = { weekday: 'short', month: 'short', day: 'numeric' };
        let dateStr = targetDate.toLocaleDateString('en-US', options).toUpperCase();

        outBox.style.borderColor = "rgba(13, 202, 240, 0.3)";
        outBox.style.background = "rgba(13, 202, 240, 0.05)";
        out.innerHTML = `TARGET COMPLETION: <span class="text-info fw-bold fs-6 ms-2">${dateStr}</span> <span class="text-white-50 ms-2">(${daysNeeded} Days)</span>`;

        // Loading State for Terminal
        terminal.innerHTML = `<span class="spinner-border spinner-border-sm text-info me-2" role="status"></span><span class="text-info opacity-75">Processing strategic advisory...</span>`;

        try {
            // Call Python Backend
            const response = await fetch('/api/strategy_brief', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    hours: currentDebtHours.toFixed(1),
                    days: daysNeeded,
                    mode: document.getElementById('online-tab').classList.contains('active') ? 'Video' : 'Reading'
                })
            });

            const data = await response.json();
            typeWriter(data.message, 'motivationText');

        } catch (error) {
            console.error('API Failed', error);
            terminal.innerHTML = `<span class="text-danger">> Connection disrupted. Maintain steady pacing to clear backlog.</span>`;
        }
    }
</script>
{% endblock %}